/*!
 * Rewriter 0.1
 * @author Andy Mikulski <github.com/andymikulski>
 * @url https://github.com/andymikulski/rewriter
 */

(function(n,w,u,D){return w.Rewriter=new function(t){t=t||{};var A=n(Rebar.div(Rebar.div({className:"rw-auth-modal"},Rebar.h1("Log in to Rewriter CMS"),Rebar.form(Rebar.span("Username"),Rebar.input({type:"text",name:"required-username",required:"required",ref:"txtUser"}),Rebar.span("Password"),Rebar.input({type:"password",name:"required-pass",ref:"txtPass"}),Rebar.input({type:"submit",value:"Log in",ref:"btnLogin"}),Rebar.input({type:"button",value:"Cancel",ref:"btnCancel"}))),Rebar.div({className:"rw-auth-dim",
ref:"dim"}))),z={Save:"btnSave",Undo:"btnUndo"},B=n(Rebar.div(Rebar.div({className:"rw-auth-item-panel"},Rebar.ul(function(){var a="",h;for(h in z)a+=Rebar.li({ref:z[h]},h);return a}())))),C=n(Rebar.div(Rebar.div({className:"rw-auth-panel"},Rebar.div("Double click text to enable editing. Changes are saved automatically when you finish editing a section."))));new Stiles({body:{"&.is-rw-editing":{".rw-auth-panel":{display:"block"},"&":{"[data-cms]":{outline:"1px dotted rgba(255,255,255,0.8)",cursor:"pointer",
"&:focus":{cursor:"auto"}}}},"&.rw-request-auth":{".rw-auth-modal":{display:"block"},".rw-auth-dim":{display:"block"}}},"[data-cms]":{opacity:0,transition:"2s opacity ease 0.1s","&.is-ready":{opacity:1}},".rw-auth-dim":{"&":{display:"none",position:"fixed",top:0,right:0,left:0,bottom:0,height:"100%",width:"100%","z-index":9,background:"rgba(0,0,0,0.9)"}},".rw-auth-modal":{"&":{display:"none",position:"fixed",top:"50%",left:"50%",transform:"translateY(-50%) translateX(-50%)","z-index":10},input:{"margin-bottom":"1em",
padding:"0 0.5em",'&[type="submit"]':{"margin-right":"1em"}}},".rw-auth-panel":{"&":{display:"none",position:"fixed",top:"0",width:"100%",height:"7vh","min-height":"60px","background-color":"rgba(0,0,0,0.8)","padding-top":"1em","text-align":"center"},li:{display:"inline-block"}},".rw-auth-item-panel":{"&":{display:"none"},li:{display:"inline-block"}}});var q={authModal:A,authPanel:C,itemPanel:B},v;for(v in q){n(u.body).append(q[v]);var x,y;q[v].find("[ref]").each(function(a,h){x=n(h);(y=x.attr("ref"))&&
""!==y&&(q[v][y]=x)})}var r={requests:{loads:{},saves:{}},crypto:function(a){var h=function(b,d){var c,e,a,f,g;a=b&2147483648;f=d&2147483648;c=b&1073741824;e=d&1073741824;g=(b&1073741823)+(d&1073741823);return c&e?g^2147483648^a^f:c|e?g&1073741824?g^3221225472^a^f:g^1073741824^a^f:g^a^f},k=function(a,b,d,c,e,f,g){a=h(a,h(h(b&d|~b&c,e),g));return h(a<<f|a>>>32-f,b)},l=function(a,b,d,c,e,f,g){a=h(a,h(h(b&c|d&~c,e),g));return h(a<<f|a>>>32-f,b)},m=function(a,b,c,d,e,f,g){a=h(a,h(h(b^c^d,e),g));return h(a<<
f|a>>>32-f,b)},p=function(a,b,c,d,e,f,g){a=h(a,h(h(c^(b|~d),e),g));return h(a<<f|a>>>32-f,b)},n=function(a){var b="",c="",d;for(d=0;3>=d;d++)c=a>>>8*d&255,c="0"+c.toString(16),b+=c.substr(c.length-2,2);return b},g=[],f,q,r,t,u,b,d,c,e;a=function(a){if(null===a||"undefined"===typeof a)return"";a+="";var b="",c,d,e=0;c=d=0;for(var e=a.length,f=0;f<e;f++){var g=a.charCodeAt(f),h=null;if(128>g)d++;else if(127<g&&2048>g)h=String.fromCharCode(g>>6|192,g&63|128);else if(55296!=(g&63488))h=String.fromCharCode(g>>
12|224,g>>6&63|128,g&63|128);else{if(55296!=(g&64512))throw new RangeError("Unmatched trail surrogate at "+f);h=a.charCodeAt(++f);if(56320!=(h&64512))throw new RangeError("Unmatched lead surrogate at "+(f-1));g=((g&1023)<<10)+(h&1023)+65536;h=String.fromCharCode(g>>18|240,g>>12&63|128,g>>6&63|128,g&63|128)}null!==h&&(d>c&&(b+=a.slice(c,d)),b+=h,c=d=f+1)}d>c&&(b+=a.slice(c,e));return b}(a);g=function(a){var b,c=a.length;b=c+8;for(var d=16*((b-b%64)/64+1),e=Array(d-1),g=0,f=0;f<c;)b=(f-f%4)/4,g=f%4*
8,e[b]|=a.charCodeAt(f)<<g,f++;b=(f-f%4)/4;e[b]|=128<<f%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(a);b=1732584193;d=4023233417;c=2562383102;e=271733878;a=g.length;for(f=0;f<a;f+=16)q=b,r=d,t=c,u=e,b=k(b,d,c,e,g[f+0],7,3614090360),e=k(e,b,d,c,g[f+1],12,3905402710),c=k(c,e,b,d,g[f+2],17,606105819),d=k(d,c,e,b,g[f+3],22,3250441966),b=k(b,d,c,e,g[f+4],7,4118548399),e=k(e,b,d,c,g[f+5],12,1200080426),c=k(c,e,b,d,g[f+6],17,2821735955),d=k(d,c,e,b,g[f+7],22,4249261313),b=k(b,d,c,e,g[f+8],7,1770035416),e=k(e,
b,d,c,g[f+9],12,2336552879),c=k(c,e,b,d,g[f+10],17,4294925233),d=k(d,c,e,b,g[f+11],22,2304563134),b=k(b,d,c,e,g[f+12],7,1804603682),e=k(e,b,d,c,g[f+13],12,4254626195),c=k(c,e,b,d,g[f+14],17,2792965006),d=k(d,c,e,b,g[f+15],22,1236535329),b=l(b,d,c,e,g[f+1],5,4129170786),e=l(e,b,d,c,g[f+6],9,3225465664),c=l(c,e,b,d,g[f+11],14,643717713),d=l(d,c,e,b,g[f+0],20,3921069994),b=l(b,d,c,e,g[f+5],5,3593408605),e=l(e,b,d,c,g[f+10],9,38016083),c=l(c,e,b,d,g[f+15],14,3634488961),d=l(d,c,e,b,g[f+4],20,3889429448),
b=l(b,d,c,e,g[f+9],5,568446438),e=l(e,b,d,c,g[f+14],9,3275163606),c=l(c,e,b,d,g[f+3],14,4107603335),d=l(d,c,e,b,g[f+8],20,1163531501),b=l(b,d,c,e,g[f+13],5,2850285829),e=l(e,b,d,c,g[f+2],9,4243563512),c=l(c,e,b,d,g[f+7],14,1735328473),d=l(d,c,e,b,g[f+12],20,2368359562),b=m(b,d,c,e,g[f+5],4,4294588738),e=m(e,b,d,c,g[f+8],11,2272392833),c=m(c,e,b,d,g[f+11],16,1839030562),d=m(d,c,e,b,g[f+14],23,4259657740),b=m(b,d,c,e,g[f+1],4,2763975236),e=m(e,b,d,c,g[f+4],11,1272893353),c=m(c,e,b,d,g[f+7],16,4139469664),
d=m(d,c,e,b,g[f+10],23,3200236656),b=m(b,d,c,e,g[f+13],4,681279174),e=m(e,b,d,c,g[f+0],11,3936430074),c=m(c,e,b,d,g[f+3],16,3572445317),d=m(d,c,e,b,g[f+6],23,76029189),b=m(b,d,c,e,g[f+9],4,3654602809),e=m(e,b,d,c,g[f+12],11,3873151461),c=m(c,e,b,d,g[f+15],16,530742520),d=m(d,c,e,b,g[f+2],23,3299628645),b=p(b,d,c,e,g[f+0],6,4096336452),e=p(e,b,d,c,g[f+7],10,1126891415),c=p(c,e,b,d,g[f+14],15,2878612391),d=p(d,c,e,b,g[f+5],21,4237533241),b=p(b,d,c,e,g[f+12],6,1700485571),e=p(e,b,d,c,g[f+3],10,2399980690),
c=p(c,e,b,d,g[f+10],15,4293915773),d=p(d,c,e,b,g[f+1],21,2240044497),b=p(b,d,c,e,g[f+8],6,1873313359),e=p(e,b,d,c,g[f+15],10,4264355552),c=p(c,e,b,d,g[f+6],15,2734768916),d=p(d,c,e,b,g[f+13],21,1309151649),b=p(b,d,c,e,g[f+4],6,4149444226),e=p(e,b,d,c,g[f+11],10,3174756917),c=p(c,e,b,d,g[f+2],15,718787259),d=p(d,c,e,b,g[f+9],21,3951481745),b=h(b,q),d=h(d,r),c=h(c,t),e=h(e,u);return(n(b)+n(d)+n(c)+n(e)).toLowerCase()},_needsAuth:t.hasOwnProperty("requireAuth")?t.requireAuth:!0,_hasAuth:t.hasOwnProperty("requireAuth")?
!t.requireAuth:!1,isReady:function(){return this._hasAuth},declineAuth:function(){n(u.body).removeClass("rw-request-auth is-rw-editing");this._clearAuthFields();return this},acceptAuth:function(){var a=n(u.body);alert("Welcome!");a.addClass("is-rw-editing").removeClass("rw-request-auth");this._clearAuthFields();return this},_clearAuthFields:function(){q.authModal.txtUser.val("");q.authModal.txtPass.val("")},getAuthentication:function(){this._hasAuth=!0;n(u.body).addClass("rw-request-auth");return this._hasAuth},
onAuthSubmit:function(a){a&&a.preventDefault&&a.preventDefault();a=n(a.currentTarget).closest("form").serializeArray();for(var h=!0,k=0;k<a.length;k++){var l=a[k],m=l.name,l=l.value;if(0===m.indexOf("required-")||""!==l)m=m.replace("required-",""),(m=w.rw[m])&&""!==m&&this.crypto(l)!==m&&(h=!1)}h?this.acceptAuth():alert("Invalid login credentials, try again")},_findAndBind:function(a){var h=this;a?a instanceof n||(a=n(a)):a=n(u.body);h._findFields(a).each(function(a,l){h._bindField(n(l))})},_findFields:function(a){return a.find("[data-cms]")},
_bindField:function(a){var h=this,k={click:h._onFieldFocus.bind(h),blur:h._onFieldBlur.bind(h)};h._requestLoad(h.getPath(a),function(){setTimeout(function(){a.addClass("is-ready")},150)});for(var l in k)a.on(l,function(a,l){return function(n){if(h.isReady())return n&&n.preventDefault&&n.preventDefault(),k[a](l)}}(l,a))},_onFieldFocus:function(a){a.attr("contenteditable");a.data("rw-before",a.html());a.attr("contenteditable",!0)},_onFieldBlur:function(a){a.html()!==a.data("rw-before")?(a.attr("is-rw-dirty",
!0),w.confirm("Save changes?")?this.requestFieldSave(a):a.html(a.data("rw-before")),a.data("rw-before","")):a.attr("is-rw-dirty",!1);a.attr("contenteditable",!1)},requestFieldSave:function(a){var h=this.getPath(a);a=a.html();a=a.replace(/contenteditable="true"/gi,"");this._requestSave(h,a)},_requestSave:function(a,h){var k=this.requests.saves;k.hasOwnProperty(a)&&k[a].abort&&k[a].abort();k[a]=n.ajax({url:"cms.php",type:"post",data:{action:"save",id:a,text:h},success:function(){k[a]=null;delete k[a]},
error:function(){}})},_requestLoad:function(a,h){var k=this.requests.loads;k.hasOwnProperty(a)&&k[a].abort||(k[a]=n.ajax({url:"cms.php",type:"post",data:{action:"load",id:a},success:function(l){l&&""!==l&&n(a).html(l);k[a]=null;delete k[a];h&&h()},error:function(){h&&h()}}))},getPath:function(a){if(1!=a.length)throw"Requires one element.";for(var h,k=a;k.length;){a=k[0];var l=a.localName;if(!l)break;var l=l.toLowerCase(),k=k.parent(),m=k.children(l);1<m.length&&(l+=":eq("+m.index(a)+")");h=l+(h?" > "+
h:"")}return h},toggleEditable:function(a){n(u.body)[a?"addClass":"removeClass"]("show-rw-cms")},saveField:function(a){this.requestFieldSave(a);a.attr("contenteditable",!1).attr("is-rw-dirty",!1)},init:function(){r._findAndBind();q.authModal.btnLogin.unbind().on("click",r.onAuthSubmit.bind(r));q.authModal.btnCancel.unbind().on("click",r.declineAuth.bind(r));q.authModal.dim.unbind().on("click",r.declineAuth.bind(r))}};t.hasOwnProperty("preventInit")&&t.preventInit||r.init();return r}})(jQuery,window,
document);